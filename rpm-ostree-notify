#!/bin/bash
#
# Notify me when the pending rpm-ostree deployment contains security advisories.
#
# Optionally, the script may initiate immediate system upgrade.
#

source "$(dirname "${0}")/rpm-ostree-notify.conf"

sleep "${START_DELAY}"  # Let rpm-ostree download latest updates

while true; do
    sec_advisories=$(rpm-ostree status | grep 'SecAdvisories')
    if [[ ${sec_advisories} ]]; then
        if [[ ${IMMEDIATE_UPGRADE} ]]; then
            rpm-ostree upgrade
            msg_end='Consider to reboot the system.'
        else
            msg_end='Consider to manually upgrade and reboot the system.'
        fi
        msg_summary='Security Advisories Available'
        msg_start='Pending rpm-ostree deployment contains security advisories:'
        adv_list=$(echo "${sec_advisories}" | cut -d':' -f2)
        # Use urgency critical to ensure I won't overlook the notification
        notify-send --urgency=critical "${msg_summary}" "${msg_start} ${adv_list}. ${msg_end}"
    fi
    sleep "${FREQUENCY}"
done
