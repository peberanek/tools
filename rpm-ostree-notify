#!/bin/bash
#
# Notify me when the pending rpm-ostree deployment contains security advisories.
#
# Optionally, the script may initiate immediate system upgrade.
#

# shellcheck source=/dev/null
source "$(dirname "${0}")/rpm-ostree-notify.conf"

msg_summary='Security Advisories Available'
msg_body="Pending rpm-ostree deployment contains security advisories. Consider to \
reboot the system."

sleep "${START_DELAY}"  # Let rpm-ostree download latest updates

while true; do
    if rpm-ostree status | grep 'SecAdvisories'; then
        if [[ ${IMMEDIATE_UPGRADE} ]]; then
            rpm-ostree upgrade
        fi
        # Use urgency critical to ensure I won't overlook the notification
        notify-send --urgency=critical "${msg_summary}" "${msg_body}"
    fi
    sleep "${FREQUENCY}"
done
